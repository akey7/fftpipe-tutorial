---
title: "fftpipe Tutorial"
description: |
  How to use the fftpipe package for R.
author:
  - name: Alicia M. F. Key 
    url: https://scialicia.com
    affiliation: Personal Projects
    affiliation_url: https://scialicia.com
date: "`r Sys.Date()`"
output: distill::distill_article
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## What is fftpipe?

`fftpipe` is a package of functions that wrap around the base R [`fft()`](https://www.rdocumentation.org/packages/stats/versions/3.6.2/topics/fft) function. The `fftpipe` package enables workflows around the [`fft()`](https://www.rdocumentation.org/packages/stats/versions/3.6.2/topics/fft) function that use the pipe (`%>%`) operator. I took inspiration for the interface to `fftpipe` from the [Tidyverse](https://www.tidyverse.org) and [tidymodels](https://www.tidymodels.org) packages.

Specifically, `fftpipe` offers the following functionality:

1. Waveform generation,
2. FFT and inverse FFT transformation,
3. Plotting of these waveforms and FFTs.

## Installation

Install `fftpipe` from GitHub with devtools. If you don't have devtools installed already, install it with `install.packages("devtools")`. Once devtools is installed, you can then install `fftpipe` by typing the following command into the R console:

```
devtools::install_github("akey7/fftpipe")
```

## Quick Start

More detail about each of these steps is described below in this document. But this will get you started!

### Load the necessary packages

While you can use `fftpipe` on its own, it is designed to work within the [Tidyverse](https://www.tidyverse.org) ecosystem, so I recommend you load the tidyverse as well. Also, I will set a theme for `ggplot()`.

```{r}
suppressPackageStartupMessages(library(fftpipe))
suppressPackageStartupMessages(library(tidyverse))
theme_set(theme_linedraw(base_size = 15))
```

### Generate a waveform

Waveforms can either be built from external data or synthesized from within the `fftpipe` package. For this quick start demo, let's compose a waveform to feed into the FFT with the following properties:

1. Its duration will be 1 second with a sample rate of 200 samples/second.
2. It will be the sum of 2 cosines, with the second cosine being 3x the frequency and 50% the amplitude of the first cosine.
3. Its total amplitude will decrease with an exponential decay function, with an [exponential time constant (tau)](https://en.wikipedia.org/wiki/Exponential_decay#Mean_lifetime) of 0.5.
4. The final result will be normalized by dividing the vector of values by the length of that vector to prepare the waveform for FFT.

We can compose this waveform using functions from fftpipe as shown in this code block:

```{r}
wv <- waveform(duration_s = 1.0, sr = 100) %>%
  cos_sum(freqs = c(2.0, 6.0), amplitudes = c(1.0, 0.9)) %>%
  length_norm()
```

### Plot the input waveform

We can streamline plotting the input waveform with the following function call. This plot can be refined in ways I'll describe later in the document.

```{r}
waveform_plot(wv)
```

### Perform the FFT

We can perform an FFT on the waveform we just made. To do that, run the following line:

```{r}
wv_fft <- wv %>%
  compute_fft()
```

We can then use this FFT `data.frame` to plot the FFT and reconstruct the original waveform in the next two steps.

### Plot the FFT

`fft_plot()` plots the FFT as shown below. By default, the plot only shows the frequency components that are at or below the [Nyquist frequency (half the sample rate)](https://en.wikipedia.org/wiki/Nyquist_frequency). Here, our sample rate is 100 Hz, so the maximum frequency is 50 Hz. This plot can be further customized, which will be shown later in the document.

Note how our original component cosines we summed together appear here as peaks at 2 Hz and 6 Hz. The first peak is taller than the second peak, which corresponds to our 6 Hz component having less amplitude than the 2 Hz component. Hence, our FFT captured the frequencies of our original waveform!

```{r}
wv_fft %>%
  fft_plot()
```

### Reconstruct the original waveform from the FFT

Finally, we can reconstruct the original waveform from the FFT. First, we need to make a waveform that defines the sample rate and values for the waveform to be reconstructed. This should match the `waveform()` call above. Then we need to feed both the new waveform and FFT into the `inverse_FFT()`. Then, we can pass the reconstruction through a `length_norm()` call and plot the reconstructed waveform.

```{r}
waveform(duration_s = 1.0, sr = 100) %>%
  inverse_fft(wv_fft) %>%
  length_norm() %>%
  waveform_plot()
```

By using `length_norm()` before and after the FFT, the amplitudes of our waveform are the same before and after the FFT.


